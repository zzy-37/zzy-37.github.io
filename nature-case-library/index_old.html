<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta name="color-scheme" content="dark"> -->
    <title>Case Library | Ecology and Culture Lab</title>

    <style>
        @font-face {
            font-family: AvenirNext;
            src: url("avenir-next/AvenirNextLTPro-Regular.otf") format("opentype");
        }

        @font-face {
            font-family: AvenirNext;
            font-weight: bold;
            src: url("avenir-next/AvenirNextLTPro-Bold.otf") format("opentype");
        }

        @font-face {
            font-family: Neutra;
            font-weight: bold;
            src: url("neutraface-text/Neutraface Text Bold.otf") format("opentype");
        }

        :root {
            --border-style: 1px solid var(--color-foreground);
            --padding-val: 0.5rem;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: AvenirNext;
            margin: 0;
        }

        h1 {
            font-family: Neutra;
        }

        img {
            max-width: 100%;
        }


        /* a:link {
        } */

        button,
        summary {
            cursor: pointer;
        }

        button {
            border: var(--border-style);
            background-color: var(--color-background);
        }

        button:hover {
            background-color: var(--color-foreground);
            color: var(--color-background);
        }
    </style>

    <style>
        :root {
            --color-background: white;
            --color-foreground: black;
        }

        .dark:root {
            --color-background: #24283b;
            --color-background-dark: #1a1b26;
            --color-background-light: #414868;
            --color-foreground: #a9b1d6;
            --color-foreground-light: #c0caf5;
            --color-accent: #e0af68;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-foreground);
            accent-color: var(--color-accent);
        }

        .filter-selector {
            background-color: var(--color-background-light);
        }

        .filter-selector b {
            color: var(--color-foreground-light);
        }

        .filter-selector label:hover {
            color: var(--color-foreground-light);
        }

        .filter-selector summary {
            /* font-weight: bold; */
            color: var(--color-foreground-light);
        }

        .projects h3 {
            color: var(--color-foreground-light);
        }
    </style>

    <style>
        header {
            border-bottom: var(--border-style);
            height: min-content;
            display: flex;
            align-items: center;
        }

        header h1 {
            margin: 0;
        }

        header img {
            max-width: 20rem;
            max-height: 3rem;
        }

        main {
            position: relative;
        }

        .filter-selector,
        .filter-selector details {
            display: flex;
            flex-direction: column;
        }

        .filter-selector label,
        .filter-selector summary {
            margin-top: var(--padding-val);
        }

        .filter-selector label {
            cursor: pointer;
            text-transform: capitalize;
        }

        .projects>div {
            /* background-color: var(--color-background); */
            /* margin-top: var(--padding-val); */
            border-bottom: var(--border-style);
        }

        .projects a {
            word-break: break-all;
            /* color: var(--color-accent); */
        }

        .projects>div h3 {
            margin: var(--padding-val) 0;
        }

        .projects>div,
        .filter-line {
            padding: var(--padding-val);
        }

        .filter-line {
            position: sticky;
            top: 0;
        }

        .filter-line {
            background-color: var(--color-background);
            /* font-weight: bold; */
            border-bottom: var(--border-style);
        }

        .filter-line button {
            font-weight: bold;
            /* font-size: large; */
            margin-left: var(--padding-val);
        }

        .wrapper {
            padding-left: var(--padding-val);
            padding-right: var(--padding-val);
        }


        @media (min-width: 600px) {
            body {
                display: flex;
                flex-direction: column;
                height: 100vh;
            }

            main {
                display: flex;
                flex: 1;
                gap: var(--padding-val);
                /* max-height: 100vh; */
                min-height: 0;
            }

            main aside {
                flex-shrink: 0;
                flex-basis: 30ch;
                border-right: var(--border-style);
            }

            main>* {
                overflow: auto;
            }

            /* .projects {
                max-width: 80ch;
            } */

            /* .filter-selector {
                border-right: var(--border-style);
            } */
        }
    </style>

    <script src="cells.js"></script>

    <script>
        const ce = name => document.createElement(name);
        const qs = (query, parent = document) => parent.querySelector(query);
        const qsa = (query, parent = document) => parent.querySelectorAll(query);

        ['div', 'p', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'a', 'ul',
            'li', 'details', 'summary', 'nav', 'header', 'footer', 'button',
            'blockquote', 'main', 'aside', 'label', 'b', 'u'
        ].forEach(name =>
            window[name] = (...children) => {
                const el = ce(name)
                el.append(...children)
                return el
            })

        const { assign } = Object
        const style = (el, styles) => {
            assign(el.style, styles)
            return el
        }
        const img = filename => assign(ce('img'), { src: filename })
        const input = type => assign(ce('input'), { type: type })
    </script>
</head>

<body>
    <script>
        'use strict'

        const rows = cells.values
        const headers = rows[0]
        const entries = rows.slice(3)

        const i_ubran_context = 6
        const i_citizen_science = 7
        const i_nature_topics = 8
        const i_technoloies = 9
        const i_other_keywords = 10
        const i_implimentation = 11

        const nature_topic_catagories = [
            'Animal',
            'Environment',
            'Material',
            'Microorganism',
            'Non-human',
            'Plants',
            'Resource',
            'Sound',
            'Species',
            'Synthetic Biology',
            'Utilization',
        ]

        const technology_catagories = [
            'AI',
            'AR',
            'Biomedia',
            'Biotech',
            'Coding',
            'Data',
            'Digital Fabrication',
            'Fabrication',
            'Sampling',
            'Sensor',
            'Sound',
            'VR',
        ]

        const implimentation_catagories = [
            'Complete',
            'Prototype',
            'Speculative',
        ]

        const other_keywords = [...new Set(entries.map(e => [
            entry_get_tokens(e, i_nature_topics).filter(token =>
                !nature_topic_catagories.map(s => s.toLowerCase()).includes(token)),
            entry_get_tokens(e, i_technoloies).filter(token =>
                !technology_catagories.map(s => s.toLowerCase()).includes(token)),
            entry_get_tokens(e, i_other_keywords)
        ]).flat(3))]

        // const head = header(
        //     img('./EAD.png'),
        //     h1('Welcome to the Ecology and Culture Lab'),
        //     p('This page is an open dataset of classified cases about current tech applications of AI, data science and digital fabrication that are already in place to serve nature and human re-connection within the city.'),
        // )

        const head = header(
            img('./Logos/hulu 30.png'),
            h1('Ecology X Design Knowledge Base')
        )

        const main_info = [
            h1('About us'),

            p('This platform collects projects and cases that address nature related topics and challenges, aiming to explore how design and technology are supporting ecological restoration and integration in a variety of applications.'),
            p('The platform provides a reference of ecology-relevant projects that can inspire both planners and citizens in how technology advancement can be supportive of new models of urban-nature integration. '),
            p('You can navigate the dataset by different “technology” and “nature” keywords, which offers a more specific outlook on how the cases have been classified.'),
            p('The platform is currently at its 1.0 release, and we expect to introduce more visualisation and UI details in version 2.0 by Summer 2023.'),

            p('The platform is created by the ', assign(a('Ecology and Cultures Innovation Lab'), { href: 'https://ecologydesignlabl.org/web' }), ' at ', assign(a('College of Design and Innovation, Tongji University'), { href: "https://tjdi.tongji.edu.cn/" }), '. The project has been funded by ', assign(a('NSFC National Natural Science Foundation of China'), { href: 'https://www.nsfc.gov.cn/english/site_1/index.html' }), ' under the grant agreement ', assign(a('2021-2022 #6201101276'), { href: 'https://ecologydesignlabl.org/web/nsfc-citizenscience/' }), '.'),

            p('Team members: Lu Wentao, Saverio Silli, Francesca Valsecchi, Zhu Ziyi'),
            p('contact us: ', assign(a('echologydesignlab at tongji.edu.cn'), { href: 'mailto:ecologydesignlab@tongji.edu.cn' })),

            assign(button(b('< Back')), {
                onclick() {
                    location.hash = 'filter'
                }
            })
        ]

        const foot = footer(
            assign(ce('style'), {
                textContent: `
                footer { border-top: 1px solid black; padding: var(--padding-val); display: flex; flex-wrap: wrap; gap: var(--padding-val) }
                footer>p { flex: 1 }
                footer img { max-height: 5rem; margin-right: var(--padding-val) }
                ` }),


            p('Designed by Ecology and Cultures Innovation Lab, Tongji D&I. Supported by ', assign(a('NSFC'), { href: 'https://www.nsfc.gov.cn/english/site_1/index.html' }), '. ', 'This work is licensed under a ', assign(a('Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License'), { rel: 'license', href: 'http://creativecommons.org/licenses/by-nc-sa/4.0/' }), '.'),

            div(
                assign(a(assign(img('./Logos/dilogo.png'), { alt: 'D&I Logo' })), { href: 'https://tjdi.tongji.edu.cn/' }),
                assign(a(assign(img('./Logos/NSFC Logo.png'), { alt: 'NSFC Logo' })), { href: 'https://www.nsfc.gov.cn/english/site_1/index.html' }),
                assign(a(assign(img('https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png'), { alt: 'Creative Commons Licence' })), { rel: 'license', href: 'http://creativecommons.org/licenses/by-nc-sa/4.0/' }),
            ),
        )

        const projs = div()

        const urban_context_count = entries.filter(e => apply_filter('Urban Context'))
        const citizen_science_count = entries.filter(e => apply_filter('Citizen Science'))

        const filter_selector = div(
            b('Filter'),

            filter_checkbox_element('Urban Context'),
            filter_checkbox_element('Citizen Science'),

            details(
                summary('Technology'),
                ...technology_catagories.map(catagroy_name =>
                    filter_checkbox_element('Technology', catagroy_name))
            ),

            details(
                summary('Nature Topic'),
                ...nature_topic_catagories.map(catagroy_name =>
                    filter_checkbox_element('Nature Topic', catagroy_name)),
            ),

            details(
                summary('Implementation'),
                ...implimentation_catagories.map(catagroy_name =>
                    filter_checkbox_element('Implementation', catagroy_name)),
            ),

            details(
                summary('Other Keywords'),
                ...other_keywords.map(catagroy_name =>
                    filter_checkbox_element('Other Keywords', catagroy_name)),
            ),
        )

        const filter_line = div()

        const checkboxes = [...filter_selector.querySelectorAll('input[type="checkbox"]')]
        checkboxes.forEach(checkbox => {
            checkbox.onchange = update_filter
        })

        const main_content = div()

        onhashchange = () => {
            if (location.hash == '#info') {
                main_content.replaceChildren(...main_info)
            }
            else {
                update_filter()
            }
        }

        const side_bar = aside(
            assign(a(h3('About')), { href: '#info' }),
            filter_selector
        )

        const main_container = main(
            side_bar,
            main_content
        )
        // qsa('details', main_container)
        //     .forEach(e => e.setAttribute('open', ''))

        projs.classList.add('projects')
        filter_selector.classList.add('filter-selector')
        filter_line.classList.add('filter-line')

        // main_container.classList.add('wrapper')
        head.classList.add('wrapper')
        side_bar.classList.add('wrapper')
        //filter_selector.classList.add('wrapper')

        document.body.append(
            head,
            main_container,
            // main_info,
            foot
        )

        update_filter()

        function filter_checkbox_element(catagory, filter = '') {
            return label(
                assign(input('checkbox'), {
                    name: catagory,
                    value: filter,
                }),
                (filter ? filter : catagory) +
                ` (${entries.filter(e => apply_filter(e, catagory, filter)).length})`,
            )
        }

        function update_filter() {
            main_content.replaceChildren(
                filter_line,
                projs,
            )
            location.hash = 'filter'
            const filter_values = checkboxes
                .filter(c => c.checked)
                .map(c => [c.name, c.value])

            if (filter_values.length === 0) {
                filter_line.replaceChildren(b(`Showing (${entries.length}): All Projects`))
                show_entries(entries)
            }
            else {
                const filtered_entries = entries.filter(row => {
                    for (const [catagory, val] of filter_values) {
                        if (apply_filter(row, catagory, val))
                            return true
                    }
                    return false
                })

                filter_line.replaceChildren(
                    b(`Showing (${filtered_entries.length}):`),
                    assign(button('Clear Filter'), {
                        onclick() {
                            checkboxes.forEach(c => c.checked = false)
                            update_filter()
                        }
                    }),
                    ...filter_values.map(([name, val]) => assign(
                        button(`× ${name}${val ? ` / ${val}` : ''}`), {
                        onclick() {
                            checkboxes.find(c => c.name === name && c.value === val).checked = false
                            update_filter()
                        }
                    }))
                )
                // filter_line.textContent = `Showing (${filtered_entries.length}): ${filter_values.join(', ')}`
                show_entries(filtered_entries)
            }
        }

        function entry_get_tokens(entry, column_index) {
            return entry[column_index] ? entry[column_index].toLowerCase().split(',').map(s => s.trim()) : []
        }

        function apply_filter(entry, catagory, filter_val = '') {
            const lower = filter_val.toLowerCase()

            return (catagory === 'Urban Context' && entry[i_ubran_context] === 'Y')
                || (catagory === 'Citizen Science' && entry[i_citizen_science] === 'Y')
                || (catagory === 'Nature Topic' && nature_topic_catagories.includes(filter_val) &&
                    entry_get_tokens(entry, i_nature_topics).includes(lower))
                || (catagory === 'Technology' && technology_catagories.includes(filter_val) &&
                    entry_get_tokens(entry, i_technoloies).includes(lower))
                || (catagory === 'Implementation' && implimentation_catagories.includes(filter_val) &&
                    entry_get_tokens(entry, i_implimentation).includes(lower))
                || (catagory === 'Other Keywords' &&
                    (entry_get_tokens(entry, i_other_keywords).includes(lower) ||
                        entry_get_tokens(entry, i_nature_topics).includes(lower) ||
                        entry_get_tokens(entry, i_technoloies).includes(lower)))
        }

        function show_entries(list) {
            projs.replaceChildren(
                ...list.map(([name, place, authors, year, link, description]) =>
                    div(
                        h3(name),
                        place ? div(b('Place '), place) : '',
                        authors ? div(b('Authors '), authors) : '',
                        year ? div(b('Year '), year) : '',
                        div(b('Link '), assign(a(link), { href: link })),
                        description ? blockquote(description) : '',
                    )
                ))
        }
    </script>
</body>

</html>