<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Library | Ecology and Culture Lab</title>

    <script src="cells.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: AvenirNext;
        }

        img {
            max-width: 100%;
        }

        a {
            word-break: break-all;
        }

        button {
            font-size: large;
        }

        header img {
            max-width: 20rem;
        }

        .tag-selector,
        header nav {
            padding: .2rem;
        }

        .tag-selector button,
        header nav button {
            margin: .2rem;
        }

        .tag-selector button:first-of-type {
            background-color: lightcoral;
        }

        .tag-selector button.selected {
            background-color: lightblue;
        }

        .projects details {
            margin: .5rem 0;
        }

        .projects>div h3 {
            margin-top: 0;
        }

        .projects>div {
            margin: .5rem 0;
            padding: .5rem;
            border: solid currentColor;
        }

        button,
        summary {
            cursor: pointer;
        }

        summary>h3 {
            display: inline;
        }

        @font-face {
            font-family: AvenirNext;
            src: url("avenir-next/AvenirNextLTPro-Regular.otf") format("opentype");
        }

        @font-face {
            font-family: AvenirNext;
            font-weight: bold;
            src: url("avenir-next/AvenirNextLTPro-Bold.otf") format("opentype");
        }

        @font-face {
            font-family: AvenirNext;
            font-style: italic;
            src: url("avenir-next/AvenirNextLTPro-It.otf") format("opentype");
        }
    </style>

    <script>
        ['div', 'p', 'span', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
            'a', 'ul', 'li', 'details', 'summary', 'nav', 'header',
            'button', 'blockquote'
        ].forEach(name =>
            window[name] = (...children) => {
                const el = document.createElement(name)
                el.append(...children)
                return el
            })

        const { assign } = Object
        const img = filename => assign(document.createElement('img'), { src: filename })
    </script>
</head>

<body>
    <script>
        const rows = cells.values
        const headers = rows[0]
        const entries = rows.slice(2)

        const i_ubran_context = headers.indexOf('Does this project has to do with urban context? Y/N')
        const i_citizen_science = i_ubran_context + 1
        const i_nature_topics   = i_ubran_context + 2
        const i_technoloies     = i_ubran_context + 3
        const i_other_keywords  = i_ubran_context + 4
        const i_implimentation  = i_ubran_context + 5

        const normalize_tags = str => str ? str.toLowerCase().split(',').map(s => s.trim()) : []

        const [topics, show_topics]      = gen_tag_selector('Nature Topics', i_nature_topics, plural => `Nature Topic${plural ? 's' : ''}`)
        const [techs, show_techs]        = gen_tag_selector('Technologies', i_technoloies, plural => `Technolog${plural ? 'ies' : 'y'}`)
        const [keywords, show_keywords]  = gen_tag_selector('Keywords', i_other_keywords, plural => `Keyword${plural ? 's' : ''}`)
        const [impls, show_impls]        = gen_tag_selector('Implementations', i_implimentation, plural => `Implementation${plural ? 's' : ''}`)

        const head = header(
            img('./EAD.png'),
            h1('Welcome to the Ecology and Culture Lab'),
            nav(
                assign(button('All'), {
                    onclick() {
                        show_all()
                    }
                }),
                assign(button('Urban Context'), {
                    onclick() {
                        current_filter.textContent = `Showing: Urban Context Projects`
                        show_entries(entries.filter(row => row[i_ubran_context] === 'Y'))
                    }
                }),
                assign(button('Citizen Science'), {
                    onclick() {
                        current_filter.textContent = `Showing: Citizen Science Projects`
                        show_entries(entries.filter(row => row[i_citizen_science] === 'Y'))
                    }
                }),
                assign(button('Nature Topics'), {
                    onclick() {
                        show_topics()
                    }
                }),
                assign(button('Technologies'), {
                    onclick() {
                        show_techs()
                    }
                }),
                assign(button('Keywords'), {
                    onclick() {
                        show_keywords()
                    }
                }),
                assign(button('Implementations'), {
                    onclick() {
                        show_impls()
                    }
                }),
            ),
            topics,
            techs,
            keywords,
            impls,
        )

        const current_filter = h2()
        const projs = div()
        projs.classList.add('projects')

        document.body.append(
            head,
            current_filter,
            projs)
        
        show_all()

        function show_all() {
            current_filter.textContent = `Showing: All Projects`
            show_entries(entries)
        }

        function show_entries(list) {
            projs.replaceChildren(
                ...list.map(([name, place, authors, year, link, description]) =>
                    div(
                        h3(name),
                        div(`Place: ${place}`),
                        div(`Authors: ${authors}`),
                        div(`Year: ${year}`),
                        div('Link: ', assign(a(link), { href: link })),
                        blockquote(description ? description : ""),
                    ))
            )
        }

        function gen_tag_selector(heading, col_index, filter_str) {
            const tags = [...new Set(entries.map(row => normalize_tags(row[col_index])).flat().filter(t => t))]
            const selected = new Set()

            const elem = details(
                summary(h3(heading)),
                assign(button('Clear'), {
                    onclick() {
                        selected.clear()
                        elem.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'))
                        show_function()
                    }
                }),
                ...tags.map(tag =>
                    assign(button(tag), {
                        onclick() {
                            if (selected.has(tag)) {
                                selected.delete(tag)
                                this.classList.remove('selected')
                            }
                            else {
                                selected.add(tag)
                                this.classList.add('selected')
                            }
                            show_function()
                        }
                    })
                )
            )
            elem.classList.add('tag-selector')

            function show_function() {
                const items = entries.filter(row => {
                    const row_tags = normalize_tags(row[col_index])
                    for (const tag of selected.keys())
                        if (row_tags?.includes(tag)) return true
                    return false
                })
                current_filter.textContent = `Showing: ${filter_str(selected.size > 1)}: ${[...selected].join(', ')}`
                show_entries(items)
            }

            return [elem, show_function]
        }
    </script>
</body>

</html>